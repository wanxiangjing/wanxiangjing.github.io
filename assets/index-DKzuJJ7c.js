import{b as se,c as te,r as W,d as H,R as i,s as ae,e as E,f as N,g as k,h as ie,i as oe,k as ne,l as Q,m as re,n as K,o as ce,p as O,q as G,j as s,t as $,v as le,w as de,x as U,y as ue,z as he,A as me,B as fe}from"./index-DLuxAid6.js";import{a as _,u as pe}from"./react-vendor-BY2yH0eA.js";import{u as A,f as x,s as ge}from"./redux-vendor-C-18dVXr.js";import{a as f,S as z,i as X,V as ve}from"./rtc-vendor-Co3qY2HD.js";import{T as Ie,e as _e,M as Se,S as ye,f as Y,g as xe,h as be,i as Ce,j as we,k as Ae,l as je}from"./ui-vendor-CtpJTzpL.js";import{l as Me}from"./logo-CiLQncpc.js";import"./utils-vendor-NIGUFBhG.js";const De=()=>{const e=A(),{parser:n}=se(),t=_.useRef({}),l=async a=>{const{kind:o,isScreen:c}=a;c&&o==="video"&&(await i.stopScreenCapture(),await i.unpublishScreenStream(f.VIDEO),e(k({publishScreen:!1})))},d=a=>{const o=JSON.parse(a.userInfo.extraInfo||"{}"),c=o.user_id||a.userInfo.userId,m=o.user_name||a.userInfo.userId;e(oe({userId:c,username:m}))},u=a=>{const{errorCode:o}=a;o===X.ErrorCode.DUPLICATE_LOGIN&&console.log("踢人")},S=a=>{e(ie(a.userInfo)),e(W(a.userInfo))},b=a=>{const{userId:o,mediaType:c}=a,m={userId:o};f.AUDIO,m.publishAudio=!0,e(N(m))},h=a=>{const{userId:o,mediaType:c}=a,m={userId:o};c===f.AUDIO&&(m.publishAudio=!1),c===f.AUDIO_AND_VIDEO&&(m.publishAudio=!1),e(N(m))},p=a=>{e(N({userId:a.userId,audioStats:a.audioStats}))},g=a=>{e(k({audioStats:a.audioStats}))},C=a=>{const o=a.find(c=>c.streamIndex===z.STREAM_INDEX_MAIN);o&&e(k({audioPropertiesInfo:o.audioPropertiesInfo}))},v=a=>{const o=a.filter(c=>c.streamKey.streamIndex===z.STREAM_INDEX_MAIN).map(c=>({userId:c.streamKey.userId,audioPropertiesInfo:c.audioPropertiesInfo}));o.length&&e(N(o))},r=async a=>{const o=await i.getDevices();if(a.mediaDeviceInfo.kind==="audioinput"){let c=a.mediaDeviceInfo.deviceId;a.deviceState==="inactive"&&(c=o.audioInputs?.[0].deviceId||""),i.switchDevice(f.AUDIO,c),e(ae(o.audioInputs)),e(E({selectedMicrophone:c}))}},y=a=>{const{userId:o,kind:c}=a;let m=t.current?.[o]||{};m={...m,[c]:!1},t.current[o]=m,e(H({userId:o}))},T=a=>{e(H({userId:a}))},M=a=>{const{type:o,userId:c}=a;let m=t.current?.[c]||{};m={...m,[o]:!1};const{audio:j,video:B}=m;return(j===!1||B===!1)&&T(c),m};return{handleError:u,handleUserJoin:d,handleUserLeave:S,handleTrackEnded:l,handleUserPublishStream:b,handleUserUnpublishStream:h,handleRemoteStreamStats:p,handleLocalStreamStats:g,handleLocalAudioPropertiesReport:C,handleRemoteAudioPropertiesReport:v,handleAudioDeviceStateChanged:r,handleAutoPlayFail:y,handlePlayerEvent:a=>{const{userId:o,rawEvent:c,type:m}=a;let j=t.current?.[o]||{};if(t.current){if(c.type==="playing"){j={...j,[m]:!0};const{audio:B,video:ee}=j;B!==!1&&ee!==!1&&e(W({userId:o}))}else c.type==="pause"&&(j=M({type:m,userId:o}));t.current[o]=j}},handleRoomBinaryMessageReceived:a=>{const{message:o}=a;n(o)},handleNetworkQuality:(a,o)=>{e(te({networkQuality:Math.floor((a+o)/2)}))},handleVideoDeviceStateChanged:a=>{console.log("handleVideoDeviceStateChanged",a)}}},R="abortVisibilityChange",P=()=>{const e=A(),{isAudioPublished:n,isVideoPublished:t,isScreenPublished:l}=x(h=>({isAudioPublished:h.roomExtra.localUser.publishAudio,isVideoPublished:h.roomExtra.localUser.publishVideo,isScreenPublished:h.roomExtra.localUser.publishScreen}),ge),d=async h=>{const p=await i.getDevices({audio:h===f.AUDIO,video:h===f.VIDEO});return h===f.AUDIO?(e(O({audioInputs:p.audioInputs})),e(E({selectedMicrophone:p.audioInputs[0]?.deviceId}))):(e(O({videoInputs:p.videoInputs})),e(E({selectedCamera:p.videoInputs[0]?.deviceId}))),p};return{isAudioPublished:n,isVideoPublished:t,isScreenPublished:l,switchMic:async(h=!0)=>{h&&await(n?i.unpublishStream(f.AUDIO):i.publishStream(f.AUDIO)),d(f.AUDIO),await(n?i.stopAudioCapture():i.startAudioCapture()),e(k({publishAudio:!n}))},switchCamera:async(h=!0)=>{h&&await(t?i.unpublishStream(f.VIDEO):i.publishStream(f.VIDEO)),d(f.VIDEO),await(t?i.stopVideoCapture():i.startVideoCapture()),e(k({publishVideo:!t}))},switchScreenCapture:async(h=!0)=>{try{l?sessionStorage.removeItem(R):sessionStorage.setItem(R,"true"),h&&await(l?i.unpublishScreenStream(f.VIDEO):i.publishScreenStream(f.VIDEO)),await(l?i.stopScreenCapture():i.startScreenCapture()),e(k({publishScreen:!l}))}catch{console.warn("Not Authorized.")}return sessionStorage.removeItem(R),!1}}},ke=()=>{const e=x(g=>g.device.devicePermissions),n=x(g=>g.room.isAIGCEnable),t=A(),{switchCamera:l,switchMic:d}=P(),[u,S]=_.useState(!1),b=De(),h=async()=>{const g="您好,欢迎使用万象镜，我是你的AI智能导游！";n?(await i.stopAgent(),t(Q()),await i.startAgent({welcomeMsg:g})):await i.startAgent({welcomeMsg:g}),t(K({isAIGCEnable:!0}))};async function p(){if(u)return;if(!await X.isSupported()){Ie.show({content:"您的浏览器可能不支持 RTC 功能，请尝试更换浏览器或升级浏览器后再重试。"});return}S(!0),await i.createEngine(),i.addEventListeners(b),await i.joinRoom();const C=await i.getDevices({audio:!0,video:!0});if(t(ce({roomId:i.basicInfo.room_id,user:{username:i.basicInfo.user_id,userId:i.basicInfo.user_id}})),t(E({selectedMicrophone:C.audioInputs[0]?.deviceId,selectedCamera:C.videoInputs[0]?.deviceId})),t(O(C)),S(!1),e.video)try{await l()}catch{G.debug("No permission for video")}if(e.audio)try{await d()}catch{G.debug("No permission for audio")}h()}return[u,p]},Ee=()=>{const e=A();return async function(){await Promise.all([i.stopAudioCapture,i.stopScreenCapture,i.stopVideoCapture]),await i.stopAgent(),await i.leaveRoom(),e(ne()),e(Q()),e(re()),e(K({isAIGCEnable:!1}))}},Ne="/assets/userAvatar-Ch7GxS-t.png",Pe="_conversation_kf49a_1",Te="_aiMsgContainer_kf49a_28",Ve="_userMsgContainer_kf49a_32",Be="_aiMsg_kf49a_28",Ue="_userMsg_kf49a_32",Re="_avatar_kf49a_50",Le="_msg_kf49a_55",Oe="_avatarWrap_kf49a_58",I={conversation:Pe,"fade-in":"_fade-in_kf49a_22","fade-out":"_fade-out_kf49a_25",aiMsgContainer:Te,userMsgContainer:Ve,aiMsg:Be,userMsg:Ue,avatar:Re,msg:Le,avatarWrap:Oe},$e="_container_72yyg_1",We="_dot_72yyg_9",F={container:$e,dot:We},J=({speed:e=.5,color:n="#ffffffff",size:t=6})=>s.jsx("div",{className:F.container,children:[0,1,2].map(l=>s.jsx("div",{className:F.dot,style:{width:`${t}px`,height:`${t}px`,backgroundColor:n,animationDelay:`${(l*(e/6)).toFixed(1)}s`}},l))});function He(){const{isAITalking:e,isUserTalking:n,msgHistory:t,isDisplay:l}=x(r=>({isDisplay:r.room.isDisplaySubtitleByTimer,msgHistory:r.room.msgHistory,isAITalking:r.room.isAITalking,isUserTalking:r.room.isUserTalking})),{user:d}=x(r=>r.user),u=_.useRef(null),S=_.useRef(null),b=A(),h=t.findLast(r=>r.user.startsWith("Chat")),p=t.findLast(r=>!r.user.startsWith("Chat")),g=()=>{b($(!0)),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{b($(!1))},5e3)},C=r=>!r.startsWith("ChatBot")&&n,v=r=>r.startsWith("ChatBot")&&e;return _.useEffect(()=>{const r=u.current;r&&(r.scrollTop=r.scrollHeight-r.clientHeight)},[t.length]),_.useEffect(()=>{g()},[h?.value,p?.value]),s.jsx("div",{ref:u,className:`${I.conversation} ${l?I["fade-in"]:I["fade-out"]} `,onScroll:g,children:t?.map(({value:r,user:y,isInterrupted:T},M)=>{const D=!y.startsWith("ChatBot"),V=y.startsWith("ChatBot");return!D&&!V?"":s.jsx("div",{className:` ${D?I.userMsgContainer:I.aiMsgContainer}`,children:s.jsxs("div",{className:`${D?I.userMsg:I.aiMsg}`,children:[V&&s.jsxs("div",{className:I.avatarWrap,children:[s.jsx("img",{src:Me,className:I.avatar,alt:""}),(C(y)||v(y))&&M===t.length-1&&s.jsx(J,{})]}),s.jsx("div",{className:I.msg,children:r}),D&&s.jsxs("div",{className:I.avatarWrap,children:[s.jsx("img",{src:d.avatar||Ne,className:I.avatar,alt:""}),M===t.length-1&&s.jsx(J,{})]}),!D&&T?s.jsx(_e,{className:I.interruptTag,children:"已打断"}):""]},`msg-${M}`)},`msg-container-${M}`)})})}const Ge="_fullMask_mkobp_1",ze={fullMask:Ge},Z=e=>s.jsx(Se,{visible:e.visible,color:"rgba(0, 0, 0, 0.7)",className:ze.fullMask,onMaskClick:e.onMaskClick,getContainer:()=>document.body,children:e.children}),Fe=()=>{const{msgHistory:e}=x(n=>n.room);return s.jsx(Z,{visible:e.length<1,children:s.jsxs(ye,{direction:"vertical",justify:"center",align:"center",children:[s.jsx(Y,{color:"#fff",style:{"--size":"36px"}}),s.jsx("span",{style:{fontSize:"1rem",color:"#fff"},children:"AI 准备中,请稍等..."})]})})},Je="_audioBtn_182b4_1",qe="_audioBtnActive_182b4_1",q={audioBtn:Je,audioBtnActive:qe},Qe=()=>{const[e,n]=_.useState(!1),{isAudioPublished:t,switchMic:l}=P(),d=async()=>{e||(n(!0),await l(!0),n(!1))};return s.jsx("div",{onClick:d,className:t?q.audioBtnActive:q.audioBtn,children:e?s.jsx(Y,{color:"#fff"}):t?s.jsx(xe,{fontSize:36,color:t?"#fff":"#eee"}):s.jsx(be,{fontSize:36,color:t?"#fff":"#eee"})})},Ke="_btn_1sjmb_1",Xe={btn:Ke},Ye="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1757474369739'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='7954'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='256'%20height='256'%3e%3cpath%20d='M960.363%20805.578v-477.05c0-54.626-29.431-93.273-82.558-93.273H758.617l-30.16-61.929c-16.492-33.456-50.937-54.631-86.839-54.631H393.221c-36.53%200-70.349%2021.175-86.841%2054.631l-30.158%2061.929H173.519c-56.777%200-109.899%2042.245-109.899%2093.273v477.05c0%2053.146%2055.312%2099.727%20109.899%2099.727H878.64c50.937%200%2082.559-42.977%2081.723-99.727z%20m-43.003%200c0%2026.999-7.092%2056.113-39.448%2056.113H173.519c-30.16%200-66.796-27.74-66.796-56.113v-477.05c0-30.592%2038.093-49.543%2066.796-49.543H303.46l42.374-85.969c9.394-18.211%2027.975-30.597%2048.115-30.597h246.938c20.146%200%2038.823%2011.646%2048.113%2030.597l42.376%2085.969h146.535c28.701%200%2039.448%2018.951%2039.448%2049.543v477.05zM602.587%20700.24c-54.587%2031.336-124.934%2029.855-175.866-8.05-41.646-31.335-65.336-80.14-65.336-131.065h69.619c1.458%200%202.191-2.967%201.458-4.342l-89.134-116.558c-0.727-0.746-2.19-1.485-2.92%200l-88.922%20116.558c-0.728%201.484%200%204.342%201.463%204.342h65.332c0%2065.533%2030.164%20126.724%2082.557%20166.109%2035.175%2026.258%2077.551%2038.642%20120.655%2038.642%2035.172%200%2070.341-9.417%20101.968-26.995%2011.374-6.565%2014.294-21.919%206.365-32.082-6.473-8.78-17.956-11.639-27.239-6.559z%20m190.264-141.232l-67.529%202.967c0.735-65.535-29.43-130.328-82.552-169.712-64.61-48.067-152.905-52.403-221.892-12.387-11.483%206.565-14.403%2021.174-6.474%2032.084%206.474%208.78%2017.955%2011.638%2027.245%206.559%2054.585-31.338%20124.929-28.371%20175.86%209.422%2042.374%2032.082%2066.065%2083.746%2065.338%20136.148l-67.529%202.967c-1.458%200-2.193%202.223-1.458%202.964l94.035%20112.12c0.728%200.736%202.191%200.736%202.92%200l84.02-119.424c0.835-1.591%200.102-3.708-1.984-3.708z'%20fill='%23ffffff'%20p-id='7955'%3e%3c/path%3e%3c/svg%3e",Ze=()=>{const{videoInputs:e,selectedCamera:n}=x(d=>d.device),t=A(),l=()=>{const d=e.find(u=>u.deviceId!==n&&!u.label.startsWith("OBS"))?.deviceId;if(console.log("切换摄像头",e),!!d)try{i.switchDevice(f.VIDEO,d),t(E({selectedCamera:d}))}catch(u){console.log("切换摄像头失败",u),t(E({selectedCamera:n}))}};return s.jsx("div",{className:Xe.btn,onClick:l,children:s.jsx("img",{src:Ye,alt:""})})},es="_roomToolBar_1rlnk_1",ss={roomToolBar:es},ts="_btn_ndemg_1",as="_settingBox_ndemg_19",is="_titleWarp_ndemg_28",os="_title_ndemg_28",ns="_settingList_ndemg_38",rs="_icon_ndemg_51",cs="_itemLabel_ndemg_60",ls="_extra_ndemg_65",w={btn:ts,settingBox:as,titleWarp:is,title:os,settingList:ns,icon:rs,itemLabel:cs,extra:ls},ds=()=>{const[e,n]=_.useState(!1),t=x(u=>u.room.isShowSubtitle),l=A(),d=u=>{u&&l($(!0)),l(le(u))};return s.jsxs(s.Fragment,{children:[s.jsx(Z,{visible:e,onMaskClick:()=>n(!1),children:s.jsxs("div",{className:w.settingBox,children:[s.jsxs("div",{className:w.titleWarp,children:[s.jsx("div",{className:w.title,children:"设置"}),s.jsx("div",{className:w.close,onClick:()=>n(!1),children:s.jsx(Ce,{color:"#a8a8a8ff",fontSize:"1.5rem"})})]}),s.jsx("ul",{className:w.settingList,children:s.jsxs("li",{children:[s.jsx("div",{className:w.icon,children:s.jsx(we,{color:"var(--adm-color-primary)",fontSize:"1.2rem"})}),s.jsx("div",{className:w.itemLabel,children:"字幕"}),s.jsx("div",{className:w.extra,children:s.jsx(Ae,{style:{"--width":"46px","--height":"24px","--border-width":"0px"},checked:t,onChange:d})})]})})]})}),s.jsx("div",{className:w.btn,onClick:()=>n(!0),children:s.jsx(je,{color:"#fff",fontSize:"2rem"})})]})};function us(){return s.jsxs("div",{className:ss.roomToolBar,children:[s.jsx(Ze,{}),s.jsx(Qe,{}),s.jsx(ds,{})]})}const hs=_.memo(us),ms="_roomContainer_1chuq_5",fs="_declare_1chuq_12",ps="_mobilePlayer_1chuq_21",L={roomContainer:ms,declare:fs,mobilePlayer:ps},gs=()=>{const e=x(d=>d.roomExtra.localUser.username),{isVideoPublished:n,isScreenPublished:t}=P();return{setVideoPlayer:_.useCallback(()=>{e&&(i.removeVideoPlayer(e),n&&i.setLocalVideoPlayer(e,"local-player",t,ve.RENDER_MODE_HIDDEN))},[n,t,e])}};function As(){const e=x(v=>v.room.isShowSubtitle),[n,t]=ke(),l=A(),{hasPreload:d,cameraPermission:u,microphonePermission:S}=x(v=>v.global),b=pe(),h=Ee(),{isVideoPublished:p}=P(),{setVideoPlayer:g}=gs(),C=()=>{l(fe({isFullScreen:!1})),n||t()};return _.useEffect(()=>{!d||!u||!S||de.getGuideScene().then(v=>{U.dispatch(ue(v.scene.id)),U.dispatch(he([v].reduce((r,y)=>(r[y.scene.id]=y.scene,r),{}))),U.dispatch(me([v].reduce((r,y)=>(r[y.scene.id]=y.rtc,r),{})))}).then(()=>{n||C()})},[]),_.useEffect(()=>((!u||!S)&&b("/permission"),()=>{console.log("退出讲解"),h()}),[]),_.useEffect(()=>{d&&p&&g()},[p]),s.jsxs("div",{className:L.roomContainer,children:[s.jsx(Fe,{}),s.jsx("div",{className:L.mobilePlayer,id:"local-player"}),e&&s.jsx(He,{}),s.jsx(hs,{}),s.jsx("div",{className:L.declare,children:"AI生成内容由大模型生成，不能完全保障真实"})]})}export{As as default};
