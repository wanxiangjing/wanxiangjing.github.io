import{u as S,s as D,j as n,b as v,d as R}from"./index-D7XsvT8O.js";import{r as M}from"./rtc-DYj_efU-.js";import{I as T}from"./handler-C8dG4T8q.js";import{T as g,s as x,C as b}from"./index-BOGKQsIG.js";import{M as m,i,R as B,S as h,a as f,V as O}from"./rtc-vendor-Co3qY2HD.js";import{a as r,u as I,h as k}from"./store-vendor-C5eEuSGF.js";import"./utils-vendor-NIGUFBhG.js";function P(l){return r.createElement("svg",Object.assign({width:"1em",height:"1em",viewBox:"0 0 48 48",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink"},l,{style:Object.assign({verticalAlign:"-0.125em"},l.style),className:["antd-mobile-icon",l.className].filter(Boolean).join(" ")}),r.createElement("g",{id:"AudioOutline-AudioOutline",stroke:"none",strokeWidth:1,fill:"none",fillRule:"evenodd"},r.createElement("g",{id:"AudioOutline-编组"},r.createElement("rect",{id:"AudioOutline-矩形",fill:"#FFFFFF",opacity:0,x:0,y:0,width:48,height:48}),r.createElement("path",{d:"M11.0280234,24.3721176 C11.0554205,24.7535019 11.0834856,25.0501619 11.1122187,25.2620977 C11.9726084,31.6083434 17.4147757,36.5 24,36.5 C30.5563593,36.5 35.9796602,31.6511327 36.8762035,25.3454661 C36.9089551,25.115114 36.9406933,24.7904814 36.9714181,24.3715686 C36.9866919,24.1625336 37.1607543,24.0007701 37.3703465,24.0007701 C37.634525,24.0007701 37.8444095,24.0007701 38,24.0007701 C38.2582838,24.0007701 38.591617,24.0007701 39,24.0007701 C39.1309734,24.0007701 39.3230245,24.0007701 39.5761532,24.0007701 C39.7971012,24.0007084 39.9762149,24.1798221 39.9762149,24.4007701 C39.9762149,24.4090903 39.9759553,24.4174084 39.9754366,24.4257124 C39.9477159,24.8694729 39.9187796,25.2146393 39.8886277,25.4612117 C39.0287343,32.4931489 33.6046985,38.1156092 26.6678639,39.2787918 C26.4729481,39.3114756 26.2013766,39.3485576 25.8531495,39.3900377 C25.6518802,39.4139065 25.5003394,39.5845847 25.5003569,39.7872643 C25.5003843,40.1036252 25.5004059,40.3526672 25.5004216,40.5343904 C25.50051,41.5562603 25.5005984,42.5781301 25.5006868,43.6 C25.5007405,43.8209139 25.3216699,44.0000155 25.100756,44.0000346 C25.1007444,44.0000346 25.1007329,44.0000346 25.1007214,44 L22.8992786,44 C22.6783647,44.0000346 22.4992786,43.8209485 22.4992786,43.6000346 C22.4992786,43.6000231 22.4992786,43.6000115 22.4993132,43.6 C22.4994011,42.583939 22.499489,41.567878 22.4995769,40.551817 C22.4995929,40.3665507 22.4996149,40.1124027 22.4996429,39.7893728 C22.4997293,39.5859497 22.3470932,39.4148995 22.1449805,39.3918467 C21.9611406,39.370878 21.8134608,39.3523813 21.7019412,39.3363565 C14.5024883,38.3018333 8.85079948,32.4787457 8.0816193,25.200152 C8.06165814,25.0112636 8.04204009,24.7526316 8.02276516,24.4242559 C8.00977186,24.2036984 8.17807611,24.0144039 8.39863633,24.0014575 C8.40644177,24.0009993 8.41425897,24.0007701 8.42207785,24.0007701 C8.66215694,24.0007701 8.85479766,24.0007701 9,24.0007701 C9.2583604,24.0007701 9.59169394,24.0007701 10,24.0007701 C10.1400474,24.0007701 10.3497683,24.0007701 10.6291627,24.0007701 C10.8388973,24.0008816 11.0129956,24.1629221 11.0280234,24.3721176 Z M24,4 C29.2492283,4 33.5045687,8.25329488 33.5045687,13.5 L33.5045687,23.5 C33.5045687,28.7467051 29.2492283,33 24,33 C18.7507717,33 14.4954313,28.7467051 14.4954313,23.5 L14.4954313,13.5 C14.4954313,8.25329488 18.7507717,4 24,4 Z M24,7 C20.4865005,7 17.6237845,9.78499621 17.500979,13.2668659 L17.4968741,13.5 L17.4968741,23.5 C17.4968741,27.0898509 20.4084227,30 24,30 C27.5134995,30 30.3762155,27.2150038 30.499021,23.7331341 L30.5031259,23.5 L30.5031259,13.5 C30.5031259,9.91014913 27.5915773,7 24,7 Z",id:"AudioOutline-形状",fill:"currentColor",fillRule:"nonzero"}))))}function j(l){return r.createElement("svg",Object.assign({width:"1em",height:"1em",viewBox:"0 0 48 48",xmlns:"http://www.w3.org/2000/svg",xmlnsXlink:"http://www.w3.org/1999/xlink"},l,{style:Object.assign({verticalAlign:"-0.125em"},l.style),className:["antd-mobile-icon",l.className].filter(Boolean).join(" ")}),r.createElement("g",{id:"CameraOutline-CameraOutline",stroke:"none",strokeWidth:1,fill:"none",fillRule:"evenodd"},r.createElement("g",{id:"CameraOutline-编组"},r.createElement("rect",{id:"CameraOutline-矩形",fill:"#FFFFFF",opacity:0,x:0,y:0,width:48,height:48}),r.createElement("path",{d:"M29.7352369,5 L29.7352369,5 C30.8779691,5 31.9107146,5.6794308 32.3609512,6.72709926 L33.6600003,9.74999944 L38.2857146,9.74999944 L38.2857143,9.74999944 C41.441625,9.74999931 44,12.301973 44,15.449997 L44,37.3000024 L44,37.3000024 C44,40.448022 41.441625,43 38.2857143,43 L9.71428593,43 L9.71428568,43 C6.55837498,43 4,40.448022 4,37.3000024 C4,37.3000024 4,37.3000024 4,37.3000024 L4,15.449997 L4,15.4499979 C4,12.3019783 6.55837052,9.7500003 9.71428568,9.7500003 L14.3399999,9.7500003 L15.639049,6.72710012 L15.6390488,6.72710065 C16.0892854,5.67942774 17.1220309,5 18.2647631,5 L29.7352541,5 L29.7352369,5 Z M29.6874418,8 L18.3125379,8 L16.2885949,12.7058932 L9.8333318,12.7058932 L9.83333193,12.7058932 C8.33302878,12.7058098 7.09273709,13.8712377 7.00472224,15.3637716 L7,15.5294187 L7,37.1764725 L7,37.1766294 C7,38.6717398 8.16954247,39.9076725 9.66726906,39.9953033 L9.83333427,40 L38.1666681,40 L38.1666681,40 C39.6669712,40 40.9072629,38.8346555 40.9952778,37.3421215 L41,37.1764745 L41,15.5294206 L41,15.5292634 C41,14.034153 39.8304575,12.7982203 38.3327309,12.7105895 L38.1666662,12.7058928 L31.711403,12.7058928 L29.68746,8 L29.6874418,8 Z M24.5,16 C29.7468582,16 34,20.2531552 34,25.5 C34,30.7468582 29.7468448,35 24.5,35 C19.2531418,35 15,30.7468448 15,25.5 C15,20.2531418 19.2531552,16 24.5,16 Z M24.5,19 L24.5,19 C20.9101422,19 18,21.9101552 18,25.5 C18,29.0898579 20.9101552,32 24.5,32 L24.5,32 C28.0898578,32 31,29.0898448 31,25.5 C31,21.9101421 28.0898448,19 24.5,19 L24.5,19 Z M36.5,15 L36.5,15 C37.3284266,15 38,15.6715734 38,16.5 C38,17.3284266 37.3284266,18 36.5,18 L36.5,18 C35.6715734,18 35,17.3284266 35,16.5 C35,15.6715734 35.6715734,15 36.5,15 L36.5,15 Z",id:"CameraOutline-形状",fill:"currentColor",fillRule:"nonzero"}))))}class V{engine;basicInfo;_audioCaptureDevice;_videoCaptureDevice;mirrorType=m.MIRROR_TYPE_RENDER;audioBotEnabled=!1;audioBotStartTime=0;createEngine=async()=>{this.engine=i.createEngine(this.basicInfo.app_id),await this.engine.setAudioCaptureConfig({noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0})};addEventListeners=({handleError:e,handleUserJoin:t,handleUserLeave:a,handleTrackEnded:s,handleUserPublishStream:u,handleUserUnpublishStream:c,handleRemoteStreamStats:p,handleLocalStreamStats:_,handleLocalAudioPropertiesReport:C,handleRemoteAudioPropertiesReport:E,handleAudioDeviceStateChanged:d,handleAutoPlayFail:L,handlePlayerEvent:N,handleRoomBinaryMessageReceived:w,handleNetworkQuality:A,handleVideoDeviceStateChanged:y})=>{this.engine.on(i.events.onError,e),this.engine.on(i.events.onUserJoined,t),this.engine.on(i.events.onUserLeave,a),this.engine.on(i.events.onTrackEnded,s),this.engine.on(i.events.onUserPublishStream,u),this.engine.on(i.events.onUserUnpublishStream,c),this.engine.on(i.events.onRemoteStreamStats,p),this.engine.on(i.events.onLocalStreamStats,_),this.engine.on(i.events.onAudioDeviceStateChanged,d),this.engine.on(i.events.onLocalAudioPropertiesReport,C),this.engine.on(i.events.onRemoteAudioPropertiesReport,E),this.engine.on(i.events.onAutoplayFailed,L),this.engine.on(i.events.onPlayerEvent,N),this.engine.on(i.events.onRoomBinaryMessageReceived,w),this.engine.on(i.events.onNetworkQuality,A),this.engine.on(i.events.onVideoDeviceStateChanged,y)};joinRoom=()=>(console.log(` ------ userJoinRoom
`,`roomId: ${this.basicInfo.room_id}
`,`uid: ${this.basicInfo.user_id}`),this.engine.joinRoom(this.basicInfo.token,`${this.basicInfo.room_id}`,{userId:this.basicInfo.user_id,extraInfo:JSON.stringify({call_scene:"RTC-AIGC",user_name:this.basicInfo.user_id,user_id:this.basicInfo.user_id})},{isAutoPublish:!0,isAutoSubscribeAudio:!0,roomProfileType:B.chat}));leaveRoom=()=>{this.audioBotEnabled=!1,this.engine&&(this.engine.leaveRoom&&this.engine.leaveRoom().catch(),i.destroyEngine(this.engine)),this._audioCaptureDevice=void 0};checkPermission(){return i.enableDevices({video:!1,audio:!0})}async getDevices(e){const{video:t=!1,audio:a=!0}=e||{};let s=[],u=[],c=[];const{video:p,audio:_}=await i.enableDevices({video:t,audio:a});if(a){const C=await i.enumerateAudioCaptureDevices(),E=await i.enumerateAudioPlaybackDevices();s=C.filter(d=>d.deviceId&&d.kind==="audioinput"),u=E.filter(d=>d.deviceId&&d.kind==="audiooutput"),this._audioCaptureDevice=s.filter(d=>d.deviceId)?.[0]?.deviceId,_?(s?.length||g.show({content:"无麦克风设备, 请先确认设备情况。",icon:"fail"}),u?.length||g.show({content:"无扬声器设备, 请先确认设备情况。",icon:"fail"})):g.show({content:"暂无麦克风设备权限, 请先确认设备权限授予情况。",icon:"fail"})}return t&&(c=await i.enumerateVideoCaptureDevices(),c=c.filter(C=>C.deviceId&&C.kind==="videoinput"),this._videoCaptureDevice=c?.[0]?.deviceId,p?c?.length||g.show({content:"无摄像头设备, 请先确认设备情况。",icon:"fail"}):g.show({content:"暂无摄像头设备权限, 请先确认设备权限授予情况。",icon:"fail"})),{audioInputs:s,audioOutputs:u,videoInputs:c}}startVideoCapture=async e=>{await this.engine.startVideoCapture(e||this._videoCaptureDevice)};stopVideoCapture=async()=>{this.engine.setLocalVideoMirrorType(m.MIRROR_TYPE_RENDER),await this.engine.stopVideoCapture()};startScreenCapture=async(e=!1)=>{await this.engine.startScreenCapture({enableAudio:e})};stopScreenCapture=async()=>{await this.engine.stopScreenCapture()};startAudioCapture=async e=>{await this.engine.startAudioCapture(e||this._audioCaptureDevice)};stopAudioCapture=async()=>{await this.engine.stopAudioCapture()};publishStream=e=>{this.engine.publishStream(e)};unpublishStream=e=>{this.engine.unpublishStream(e)};publishScreenStream=async e=>{await this.engine.publishScreen(e)};unpublishScreenStream=async e=>{await this.engine.unpublishScreen(e)};setScreenEncoderConfig=async e=>{await this.engine.setScreenEncoderConfig(e)};setBusinessId=e=>{this.engine.setBusinessId(e)};setAudioVolume=e=>{this.engine.setCaptureVolume(h.STREAM_INDEX_MAIN,e),this.engine.setCaptureVolume(h.STREAM_INDEX_SCREEN,e)};setAudioProfile=e=>{this.engine.setAudioProfile(e)};switchDevice=(e,t)=>{e===f.AUDIO&&(this._audioCaptureDevice=t,this.engine.setAudioCaptureDevice(t)),e===f.VIDEO&&(this._videoCaptureDevice=t,this.engine.setVideoCaptureDevice(t).then(()=>{this.checkMirrorType()})),e===f.AUDIO_AND_VIDEO&&(this._audioCaptureDevice=t,this._videoCaptureDevice=t,this.engine.setVideoCaptureDevice(t),this.engine.setAudioCaptureDevice(t))};setLocalVideoMirrorType=e=>this.engine.setLocalVideoMirrorType(e);checkMirrorType=()=>{this.mirrorType===m.MIRROR_TYPE_RENDER?(this.setLocalVideoMirrorType(m.MIRROR_TYPE_NONE),this.mirrorType=m.MIRROR_TYPE_NONE):(this.setLocalVideoMirrorType(m.MIRROR_TYPE_RENDER),this.mirrorType=m.MIRROR_TYPE_RENDER)};setLocalVideoPlayer=(e,t,a=!1,s=O.RENDER_MODE_FILL)=>this.engine.setLocalVideoPlayer(a?h.STREAM_INDEX_SCREEN:h.STREAM_INDEX_MAIN,{renderDom:t,userId:e,renderMode:s});removeVideoPlayer=(e,t="Both")=>{let a=t===h.STREAM_INDEX_SCREEN,s=t===h.STREAM_INDEX_MAIN;t==="Both"&&(s=!0,a=!0),a&&this.engine.setLocalVideoPlayer(h.STREAM_INDEX_SCREEN,{userId:e}),s&&this.engine.setLocalVideoPlayer(h.STREAM_INDEX_MAIN,{userId:e})};startAgent=async e=>{this.audioBotEnabled&&await this.stopAgent(),await M.guidStartVoiceChat({welcomeMsg:e?.welcomeMsg,roomId:this.basicInfo.room_id,userId:this.basicInfo.user_id}),this.audioBotEnabled=!0,this.audioBotStartTime=Date.now()};stopAgent=async()=>{this.audioBotStartTime=0,sessionStorage.removeItem("audioBotEnabled"),this.audioBotEnabled=!1};commandAgent=({command:e,agentName:t,interruptMode:a=T.NONE,message:s=""})=>{if(this.audioBotEnabled){this.engine.sendUserBinaryMessage(t,x(JSON.stringify({Command:e,InterruptMode:a,Message:s}),"ctrl")).then(u=>{console.log(u)});return}console.warn("Interrupt failed, bot not enabled.")};updateAgent=async e=>{this.audioBotEnabled?(await this.stopAgent(),await this.startAgent()):await this.startAgent()};getAgentEnabled=()=>this.audioBotEnabled}const F="_container_rllpl_1",U="_content_rllpl_17",X="_title_rllpl_24",Y="_phone_rllpl_32",Z="_phoneScreen_rllpl_44",W="_permissionIconWrapper_rllpl_59",$="_icon_rllpl_69",J="_okIcon_rllpl_73",q="_connector_rllpl_79",z="_phoneButton1_rllpl_91",G="_phoneButton2_rllpl_101",Q="_description_rllpl_111",H="_note_rllpl_119",K="_buttonContainer_rllpl_126",ee="_permissionButton_rllpl_131",te="_backgroundElement1_rllpl_153",ie="_backgroundElement2_rllpl_165",o={container:F,content:U,title:X,phone:Y,phoneScreen:Z,permissionIconWrapper:W,icon:$,okIcon:J,connector:q,phoneButton1:z,phoneButton2:G,description:Q,note:H,buttonContainer:K,permissionButton:ee,backgroundElement1:te,backgroundElement2:ie},ue=()=>{const l=r.useRef(null),{cameraPermission:e,microphonePermission:t}=I(p=>p.global),a=I(p=>p.rtcClient.RtcClient),s=k(),u=S(),c=()=>{console.log("请求摄像头和麦克风权限"),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(()=>{s(v(!0)),s(R(!0)),setTimeout(()=>{u("/room")},1e3)}).catch(()=>{g.show({icon:"error",content:"权限请求失败,请重试"}),s(v(!1)),s(R(!1))})};return r.useEffect(()=>{a||(console.log("初始化rtcClient"),s(D(new V)))},[]),r.useEffect(()=>{e&&t&&l.current&&(l.current.style.width="50%")},[e,t]),n.jsxs("div",{className:o.container,id:"permission-screen",children:[n.jsxs("div",{className:o.content,children:[n.jsx("h2",{className:o.title,children:"开启智能导览"}),n.jsxs("div",{className:o.phone,children:[n.jsxs("div",{className:o.phoneScreen,children:[n.jsx("div",{className:o.permissionIconWrapper,id:"camera-permission",style:{backgroundColor:e?"#52c41a":"auto"},children:e?n.jsx(b,{className:o.okIcon}):n.jsx(j,{className:o.icon})}),n.jsx("div",{className:o.permissionIconWrapper,id:"mic-permission",style:{backgroundColor:t?"#52c41a":"auto"},children:t?n.jsx(b,{className:o.okIcon}):n.jsx(P,{className:o.icon})}),n.jsx("div",{ref:l,className:o.connector,id:"permission-connector"})]}),n.jsx("div",{className:o.phoneButton1}),n.jsx("div",{className:o.phoneButton2})]}),n.jsx("p",{className:o.description,children:"为了提供AI讲解服务，需要开启麦克风和摄像头权限"}),n.jsx("p",{className:o.note,children:"我们高度重视您的隐私，所有数据仅用于为您提供服务"})]}),n.jsx("div",{className:o.buttonContainer,children:n.jsx("button",{className:o.permissionButton,id:"request-permissions",onClick:c,children:"一键开启权限"})}),n.jsx("div",{className:o.backgroundElement1}),n.jsx("div",{className:o.backgroundElement2})]})};export{ue as default};
