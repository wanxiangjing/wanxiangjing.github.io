import{b as ee,r as $,c as W,d as se,e as k,f as E,g as D,h as te,i as ae,k as ie,l as q,m as oe,n as Q,o as ne,p as L,j as s,q as O,t as re,v as V,w as ce,x as le,y as de,z as ue}from"./index-C7R3IaCj.js";import{r as me}from"./rtc-BarK11XP.js";import{a as _,u as he}from"./core-vendor-BY2yH0eA.js";import{f as w,u as p,s as fe}from"./store-vendor-BtW7VYLY.js";import{a as f,S as H,i as K,V as pe}from"./rtc-vendor-Co3qY2HD.js";import{u as ge,l as G}from"./handler-D0bmgxbA.js";import{a as ve,e as Ie,M as Ce,S as _e,f as X,g as Se,h as ye,i as xe,j as be,k as we,l as Ae}from"./ui-vendor-B_BG4PkP.js";import{l as je}from"./logo-CiLQncpc.js";import"./index-DQn4vhZc.js";import"./utils-vendor-NIGUFBhG.js";const Me=()=>{const e=w(),{parser:a}=ge(),t=p(i=>i.rtcClient.RtcClient),o=_.useRef({}),u=async i=>{const{kind:n,isScreen:l}=i;l&&n==="video"&&(await t?.stopScreenCapture(),await t?.unpublishScreenStream(f.VIDEO),e(D({publishScreen:!1})))},c=i=>{const n=JSON.parse(i.userInfo.extraInfo||"{}"),l=n.user_id||i.userInfo.userId,m=n.user_name||i.userInfo.userId;e(ae({userId:l,username:m}))},h=i=>{const{errorCode:n}=i;n===K.ErrorCode.DUPLICATE_LOGIN&&console.log("踢人")},y=i=>{e(te(i.userInfo)),e($(i.userInfo))},b=i=>{const{userId:n,mediaType:l}=i,m={userId:n};f.AUDIO,m.publishAudio=!0,e(E(m))},d=i=>{const{userId:n,mediaType:l}=i,m={userId:n};l===f.AUDIO&&(m.publishAudio=!1),l===f.AUDIO_AND_VIDEO&&(m.publishAudio=!1),e(E(m))},I=i=>{e(E({userId:i.userId,audioStats:i.audioStats}))},g=i=>{e(D({audioStats:i.audioStats}))},v=i=>{const n=i.find(l=>l.streamIndex===H.STREAM_INDEX_MAIN);n&&e(D({audioPropertiesInfo:n.audioPropertiesInfo}))},r=i=>{const n=i.filter(l=>l.streamKey.streamIndex===H.STREAM_INDEX_MAIN).map(l=>({userId:l.streamKey.userId,audioPropertiesInfo:l.audioPropertiesInfo}));n.length&&e(E(n))},S=async i=>{const n=await t?.getDevices();if(i.mediaDeviceInfo.kind==="audioinput"){let l=i.mediaDeviceInfo.deviceId;i.deviceState==="inactive"&&(l=n?.audioInputs?.[0].deviceId||""),t?.switchDevice(f.AUDIO,l),e(se(n?.audioInputs||[])),e(k({selectedMicrophone:l}))}},R=i=>{const{userId:n,kind:l}=i;let m=o.current?.[n]||{};m={...m,[l]:!1},o.current[n]=m,e(W({userId:n}))},M=i=>{e(W({userId:i}))},A=i=>{const{type:n,userId:l}=i;let m=o.current?.[l]||{};m={...m,[n]:!1};const{audio:j,video:T}=m;return(j===!1||T===!1)&&M(l),m};return{handleError:h,handleUserJoin:c,handleUserLeave:y,handleTrackEnded:u,handleUserPublishStream:b,handleUserUnpublishStream:d,handleRemoteStreamStats:I,handleLocalStreamStats:g,handleLocalAudioPropertiesReport:v,handleRemoteAudioPropertiesReport:r,handleAudioDeviceStateChanged:S,handleAutoPlayFail:R,handlePlayerEvent:i=>{const{userId:n,rawEvent:l,type:m}=i;let j=o.current?.[n]||{};if(o.current){if(l.type==="playing"){j={...j,[m]:!0};const{audio:T,video:Z}=j;T!==!1&&Z!==!1&&e($({userId:n}))}else l.type==="pause"&&(j=A({type:m,userId:n}));o.current[n]=j}},handleRoomBinaryMessageReceived:i=>{const{message:n}=i;a(n)},handleNetworkQuality:(i,n)=>{e(ee({networkQuality:Math.floor((i+n)/2)}))},handleVideoDeviceStateChanged:i=>{console.log("handleVideoDeviceStateChanged",i)}}},U="abortVisibilityChange",N=()=>{const e=w(),a=p(d=>d.rtcClient.RtcClient),{isAudioPublished:t,isVideoPublished:o,isScreenPublished:u}=p(d=>({isAudioPublished:d.roomExtra.localUser.publishAudio,isVideoPublished:d.roomExtra.localUser.publishVideo,isScreenPublished:d.roomExtra.localUser.publishScreen}),fe),c=async d=>{const I=await a?.getDevices({audio:d===f.AUDIO,video:d===f.VIDEO});return d===f.AUDIO?(e(L({audioInputs:I?.audioInputs})),e(k({selectedMicrophone:I?.audioInputs[0]?.deviceId}))):(e(L({videoInputs:I?.videoInputs})),e(k({selectedCamera:I?.videoInputs[0]?.deviceId}))),I};return{isAudioPublished:t,isVideoPublished:o,isScreenPublished:u,switchMic:async(d=!0)=>{d&&await(t?a?.unpublishStream(f.AUDIO):a?.publishStream(f.AUDIO)),c(f.AUDIO),await(t?a?.stopAudioCapture():a?.startAudioCapture()),e(D({publishAudio:!t}))},switchCamera:async(d=!0)=>{d&&await(o?a?.unpublishStream(f.VIDEO):a?.publishStream(f.VIDEO)),c(f.VIDEO),await(o?a?.stopVideoCapture():a?.startVideoCapture()),e(D({publishVideo:!o}))},switchScreenCapture:async(d=!0)=>{try{u?sessionStorage.removeItem(U):sessionStorage.setItem(U,"true"),d&&await(u?a?.unpublishScreenStream(f.VIDEO):a?.publishScreenStream(f.VIDEO)),await(u?a?.stopScreenCapture():a?.startScreenCapture()),e(D({publishScreen:!u}))}catch{console.warn("Not Authorized.")}return sessionStorage.removeItem(U),!1}}},De=()=>{const e=p(g=>g.device.devicePermissions),a=p(g=>g.room.isAIGCEnable),t=p(g=>g.rtcClient.RtcClient),o=w(),{switchCamera:u,switchMic:c}=N(),[h,y]=_.useState(!1),b=Me(),d=async()=>{const g="您好,欢迎使用万象镜，我是你的AI智能导游！";a?(await t?.stopAgent(),o(q()),await t?.startAgent({welcomeMsg:g})):await t?.startAgent({welcomeMsg:g}),o(Q({isAIGCEnable:!0}))};async function I(){if(h)return;if(!await K.isSupported()){ve.show({content:"您的浏览器可能不支持 RTC 功能，请尝试更换浏览器或升级浏览器后再重试。"});return}y(!0),await t?.createEngine(),t?.addEventListeners(b),await t?.joinRoom();const v=await t?.getDevices({audio:!0,video:!0});if(o(ne({roomId:t?.basicInfo.room_id,user:{username:t?.basicInfo.user_id,userId:t?.basicInfo.user_id}})),o(k({selectedMicrophone:v.audioInputs[0]?.deviceId,selectedCamera:v.videoInputs[0]?.deviceId})),o(L(v)),y(!1),e.video)try{await u()}catch{G.debug("No permission for video")}if(e.audio)try{await c()}catch{G.debug("No permission for audio")}d()}return[h,I]},ke=()=>{const e=w(),a=p(t=>t.rtcClient.RtcClient);return async function(){await Promise.all([a?.stopAudioCapture,a?.stopScreenCapture,a?.stopVideoCapture]),await a?.stopAgent(),await a?.leaveRoom(),e(ie()),e(q()),e(oe()),e(Q({isAIGCEnable:!1}))}},Ee="/assets/userAvatar-Ch7GxS-t.png",Ne="_container_72yyg_1",Re="_dot_72yyg_9",z={container:Ne,dot:Re},F=({speed:e=.5,color:a="#ffffffff",size:t=6})=>s.jsx("div",{className:z.container,children:[0,1,2].map(o=>s.jsx("div",{className:z.dot,style:{width:`${t}px`,height:`${t}px`,backgroundColor:a,animationDelay:`${(o*(e/6)).toFixed(1)}s`}},o))}),Pe="_conversation_kf49a_1",Te="_aiMsgContainer_kf49a_28",Ve="_userMsgContainer_kf49a_32",Ue="_aiMsg_kf49a_28",Be="_userMsg_kf49a_32",Le="_avatar_kf49a_50",Oe="_msg_kf49a_55",$e="_avatarWrap_kf49a_58",C={conversation:Pe,"fade-in":"_fade-in_kf49a_22","fade-out":"_fade-out_kf49a_25",aiMsgContainer:Te,userMsgContainer:Ve,aiMsg:Ue,userMsg:Be,avatar:Le,msg:Oe,avatarWrap:$e};function We(){const{isAITalking:e,isUserTalking:a,msgHistory:t,isDisplay:o}=p(r=>({isDisplay:r.room.isDisplaySubtitleByTimer,msgHistory:r.room.msgHistory,isAITalking:r.room.isAITalking,isUserTalking:r.room.isUserTalking})),{user:u}=p(r=>r.user),c=_.useRef(null),h=_.useRef(null),y=w(),b=t.findLast(r=>r.user.startsWith("Chat")),d=t.findLast(r=>!r.user.startsWith("Chat")),I=()=>{y(O(!0)),h.current&&clearTimeout(h.current),h.current=setTimeout(()=>{y(O(!1))},5e3)},g=r=>!r.startsWith("ChatBot")&&a,v=r=>r.startsWith("ChatBot")&&e;return _.useEffect(()=>{const r=c.current;r&&(r.scrollTop=r.scrollHeight-r.clientHeight)},[t.length]),_.useEffect(()=>{I()},[b?.value,d?.value]),s.jsx("div",{ref:c,className:`${C.conversation} ${o?C["fade-in"]:C["fade-out"]} `,onScroll:I,children:t?.map(({value:r,user:S,isInterrupted:R},M)=>{const A=!S.startsWith("ChatBot"),P=S.startsWith("ChatBot");return!A&&!P?"":s.jsx("div",{className:` ${A?C.userMsgContainer:C.aiMsgContainer}`,children:s.jsxs("div",{className:`${A?C.userMsg:C.aiMsg}`,children:[P&&s.jsxs("div",{className:C.avatarWrap,children:[s.jsx("img",{src:je,className:C.avatar,alt:""}),(g(S)||v(S))&&M===t.length-1&&s.jsx(F,{})]}),s.jsx("div",{className:C.msg,children:r}),A&&s.jsxs("div",{className:C.avatarWrap,children:[s.jsx("img",{src:u.avatar||Ee,className:C.avatar,alt:""}),M===t.length-1&&s.jsx(F,{})]}),!A&&R?s.jsx(Ie,{className:C.interruptTag,children:"已打断"}):""]},`msg-${M}`)},`msg-container-${M}`)})})}const He="_fullMask_mkobp_1",Ge={fullMask:He},Y=e=>s.jsx(Ce,{visible:e.visible,color:"rgba(0, 0, 0, 0.7)",className:Ge.fullMask,onMaskClick:e.onMaskClick,getContainer:()=>document.body,children:e.children}),ze=()=>{const{msgHistory:e}=p(a=>a.room);return s.jsx(Y,{visible:e.length<1,children:s.jsxs(_e,{direction:"vertical",justify:"center",align:"center",children:[s.jsx(X,{color:"#fff",style:{"--size":"36px"}}),s.jsx("span",{style:{fontSize:"1rem",color:"#fff"},children:"AI 准备中,请稍等..."})]})})},Fe="_audioBtn_182b4_1",Je="_audioBtnActive_182b4_1",J={audioBtn:Fe,audioBtnActive:Je},qe=()=>{const[e,a]=_.useState(!1),{isAudioPublished:t,switchMic:o}=N(),u=async()=>{e||(a(!0),await o(!0),a(!1))};return s.jsx("div",{onClick:u,className:t?J.audioBtnActive:J.audioBtn,children:e?s.jsx(X,{color:"#fff"}):t?s.jsx(Se,{fontSize:36,color:t?"#fff":"#eee"}):s.jsx(ye,{fontSize:36,color:t?"#fff":"#eee"})})},Qe="_btn_1sjmb_1",Ke={btn:Qe},Xe="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1757474369739'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='7954'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='256'%20height='256'%3e%3cpath%20d='M960.363%20805.578v-477.05c0-54.626-29.431-93.273-82.558-93.273H758.617l-30.16-61.929c-16.492-33.456-50.937-54.631-86.839-54.631H393.221c-36.53%200-70.349%2021.175-86.841%2054.631l-30.158%2061.929H173.519c-56.777%200-109.899%2042.245-109.899%2093.273v477.05c0%2053.146%2055.312%2099.727%20109.899%2099.727H878.64c50.937%200%2082.559-42.977%2081.723-99.727z%20m-43.003%200c0%2026.999-7.092%2056.113-39.448%2056.113H173.519c-30.16%200-66.796-27.74-66.796-56.113v-477.05c0-30.592%2038.093-49.543%2066.796-49.543H303.46l42.374-85.969c9.394-18.211%2027.975-30.597%2048.115-30.597h246.938c20.146%200%2038.823%2011.646%2048.113%2030.597l42.376%2085.969h146.535c28.701%200%2039.448%2018.951%2039.448%2049.543v477.05zM602.587%20700.24c-54.587%2031.336-124.934%2029.855-175.866-8.05-41.646-31.335-65.336-80.14-65.336-131.065h69.619c1.458%200%202.191-2.967%201.458-4.342l-89.134-116.558c-0.727-0.746-2.19-1.485-2.92%200l-88.922%20116.558c-0.728%201.484%200%204.342%201.463%204.342h65.332c0%2065.533%2030.164%20126.724%2082.557%20166.109%2035.175%2026.258%2077.551%2038.642%20120.655%2038.642%2035.172%200%2070.341-9.417%20101.968-26.995%2011.374-6.565%2014.294-21.919%206.365-32.082-6.473-8.78-17.956-11.639-27.239-6.559z%20m190.264-141.232l-67.529%202.967c0.735-65.535-29.43-130.328-82.552-169.712-64.61-48.067-152.905-52.403-221.892-12.387-11.483%206.565-14.403%2021.174-6.474%2032.084%206.474%208.78%2017.955%2011.638%2027.245%206.559%2054.585-31.338%20124.929-28.371%20175.86%209.422%2042.374%2032.082%2066.065%2083.746%2065.338%20136.148l-67.529%202.967c-1.458%200-2.193%202.223-1.458%202.964l94.035%20112.12c0.728%200.736%202.191%200.736%202.92%200l84.02-119.424c0.835-1.591%200.102-3.708-1.984-3.708z'%20fill='%23ffffff'%20p-id='7955'%3e%3c/path%3e%3c/svg%3e",Ye=()=>{const{videoInputs:e,selectedCamera:a}=p(c=>c.device),t=p(c=>c.rtcClient.RtcClient),o=w(),u=()=>{const c=e.find(h=>h.deviceId!==a&&!h.label.startsWith("OBS"))?.deviceId;if(console.log("切换摄像头",e),!!c)try{t?.switchDevice(f.VIDEO,c),o(k({selectedCamera:c}))}catch(h){console.log("切换摄像头失败",h),o(k({selectedCamera:a}))}};return s.jsx("div",{className:Ke.btn,onClick:u,children:s.jsx("img",{src:Xe,alt:""})})},Ze="_roomToolBar_1rlnk_1",es={roomToolBar:Ze},ss="_btn_ndemg_1",ts="_settingBox_ndemg_19",as="_titleWarp_ndemg_28",is="_title_ndemg_28",os="_settingList_ndemg_38",ns="_icon_ndemg_51",rs="_itemLabel_ndemg_60",cs="_extra_ndemg_65",x={btn:ss,settingBox:ts,titleWarp:as,title:is,settingList:os,icon:ns,itemLabel:rs,extra:cs},ls=()=>{const[e,a]=_.useState(!1),t=p(c=>c.room.isShowSubtitle),o=w(),u=c=>{c&&o(O(!0)),o(re(c))};return s.jsxs(s.Fragment,{children:[s.jsx(Y,{visible:e,onMaskClick:()=>a(!1),children:s.jsxs("div",{className:x.settingBox,children:[s.jsxs("div",{className:x.titleWarp,children:[s.jsx("div",{className:x.title,children:"设置"}),s.jsx("div",{className:x.close,onClick:()=>a(!1),children:s.jsx(xe,{color:"#a8a8a8ff",fontSize:"1.5rem"})})]}),s.jsx("ul",{className:x.settingList,children:s.jsxs("li",{children:[s.jsx("div",{className:x.icon,children:s.jsx(be,{color:"var(--adm-color-primary)",fontSize:"1.2rem"})}),s.jsx("div",{className:x.itemLabel,children:"字幕"}),s.jsx("div",{className:x.extra,children:s.jsx(we,{style:{"--width":"46px","--height":"24px","--border-width":"0px"},checked:t,onChange:u})})]})})]})}),s.jsx("div",{className:x.btn,onClick:()=>a(!0),children:s.jsx(Ae,{color:"#fff",fontSize:"2rem"})})]})};function ds(){return s.jsxs("div",{className:es.roomToolBar,children:[s.jsx(Ye,{}),s.jsx(qe,{}),s.jsx(ls,{})]})}const us=_.memo(ds),ms="_roomContainer_1chuq_5",hs="_declare_1chuq_12",fs="_mobilePlayer_1chuq_21",B={roomContainer:ms,declare:hs,mobilePlayer:fs},ps=()=>{const e=p(c=>c.roomExtra.localUser.username),a=p(c=>c.rtcClient.RtcClient),{isVideoPublished:t,isScreenPublished:o}=N();return{setVideoPlayer:_.useCallback(()=>{e&&(a?.removeVideoPlayer(e),t&&a?.setLocalVideoPlayer(e,"local-player",o,pe.RENDER_MODE_HIDDEN))},[t,o,e])}};function Ds(){const e=p(v=>v.room.isShowSubtitle),[a,t]=De(),o=w(),{hasPreload:u,cameraPermission:c,microphonePermission:h}=p(v=>v.global),y=he(),b=ke(),{isVideoPublished:d}=N(),{setVideoPlayer:I}=ps(),g=()=>{o(ue({isFullScreen:!1})),a||t()};return _.useEffect(()=>{!u||!c||!h||me.getGuideScene().then(v=>{V.dispatch(ce(v.scene.id)),V.dispatch(le([v].reduce((r,S)=>(r[S.scene.id]=S.scene,r),{}))),V.dispatch(de([v].reduce((r,S)=>(r[S.scene.id]=S.rtc,r),{})))}).then(()=>{a||g()})},[]),_.useEffect(()=>((!c||!h)&&y("/permission"),()=>{console.log("退出讲解"),b()}),[]),_.useEffect(()=>{u&&d&&I()},[d]),s.jsxs("div",{className:B.roomContainer,children:[s.jsx(ze,{}),s.jsx("div",{className:B.mobilePlayer,id:"local-player"}),e&&s.jsx(We,{}),s.jsx(us,{}),s.jsx("div",{className:B.declare,children:"AI生成内容由大模型生成，不能完全保障真实"})]})}export{Ds as default};
